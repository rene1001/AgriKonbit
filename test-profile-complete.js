const mysql = require('mysql2/promise');
const fs = require('fs');
const path = require('path');
const http = require('http');
require('dotenv').config({ path: path.join(__dirname, 'server', '.env') });

// Couleurs pour le terminal
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function testHttp(url) {
  return new Promise((resolve, reject) => {
    const urlObj = new URL(url);
    const options = {
      hostname: urlObj.hostname,
      port: urlObj.port,
      path: urlObj.pathname,
      method: 'GET',
      timeout: 3000
    };

    const req = http.request(options, (res) => {
      resolve({ status: res.statusCode, ok: res.statusCode === 200 });
    });

    req.on('error', (err) => {
      resolve({ status: 0, ok: false, error: err.message });
    });

    req.on('timeout', () => {
      req.destroy();
      resolve({ status: 0, ok: false, error: 'Timeout' });
    });

    req.end();
  });
}

async function verifyProfile() {
  console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  log('‚ïë        üîç V√âRIFICATION COMPL√àTE - PROFIL & UPLOAD       ‚ïë', 'cyan');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

  let allGood = true;

  // ==========================================
  // 1. V√âRIFIER LA BASE DE DONN√âES
  // ==========================================
  log('üìä 1. V√âRIFICATION BASE DE DONN√âES', 'blue');
  console.log('‚îÄ'.repeat(60) + '\n');

  try {
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_NAME || 'agrikonbit'
    });

    log('   ‚úÖ Connexion √† la base de donn√©es r√©ussie', 'green');

    // V√©rifier les colonnes
    const [columns] = await connection.query(`
      SELECT COLUMN_NAME, COLUMN_TYPE, IS_NULLABLE
      FROM INFORMATION_SCHEMA.COLUMNS 
      WHERE TABLE_SCHEMA = ? 
      AND TABLE_NAME = 'users' 
      AND COLUMN_NAME IN ('bio', 'theme_preference', 'profile_image')
    `, [process.env.DB_NAME || 'agrikonbit']);

    const columnMap = {};
    columns.forEach(col => {
      columnMap[col.COLUMN_NAME] = col;
    });

    if (columnMap['bio']) {
      log('   ‚úÖ Colonne bio existe', 'green');
    } else {
      log('   ‚ùå Colonne bio manquante', 'red');
      allGood = false;
    }

    if (columnMap['theme_preference']) {
      log('   ‚úÖ Colonne theme_preference existe', 'green');
    } else {
      log('   ‚ùå Colonne theme_preference manquante', 'red');
      allGood = false;
    }

    if (columnMap['profile_image']) {
      log('   ‚úÖ Colonne profile_image existe', 'green');
    } else {
      log('   ‚ùå Colonne profile_image manquante', 'red');
      allGood = false;
    }

    // Tester la requ√™te profile
    const [users] = await connection.query(`
      SELECT 
        u.id, u.email, u.full_name,
        COALESCE(u.bio, '') as bio,
        COALESCE(u.theme_preference, 'light') as theme_preference,
        u.profile_image,
        COALESCE(uw.gyt_balance, 0) as gyt_balance
      FROM users u
      LEFT JOIN user_wallets uw ON u.id = uw.user_id
      LIMIT 1
    `);

    if (users.length > 0) {
      log('   ‚úÖ Requ√™te profile fonctionne', 'green');
      log(`   ‚ÑπÔ∏è  User test: ${users[0].email}`, 'cyan');
    } else {
      log('   ‚ö†Ô∏è  Aucun utilisateur en base', 'yellow');
    }

    await connection.end();

  } catch (error) {
    log('   ‚ùå Erreur base de donn√©es: ' + error.message, 'red');
    allGood = false;
  }

  console.log('');

  // ==========================================
  // 2. V√âRIFIER LES DOSSIERS
  // ==========================================
  log('üìÅ 2. V√âRIFICATION DOSSIERS', 'blue');
  console.log('‚îÄ'.repeat(60) + '\n');

  const uploadsDir = path.join(__dirname, 'uploads');
  const profilesDir = path.join(__dirname, 'uploads', 'profiles');

  if (fs.existsSync(uploadsDir)) {
    log('   ‚úÖ Dossier uploads/ existe', 'green');
  } else {
    log('   ‚ùå Dossier uploads/ manquant', 'red');
    allGood = false;
  }

  if (fs.existsSync(profilesDir)) {
    log('   ‚úÖ Dossier uploads/profiles/ existe', 'green');
    
    // Compter les fichiers
    const files = fs.readdirSync(profilesDir);
    log(`   ‚ÑπÔ∏è  ${files.length} fichier(s) dans uploads/profiles/`, 'cyan');
  } else {
    log('   ‚ùå Dossier uploads/profiles/ manquant', 'red');
    allGood = false;
  }

  // V√©rifier les permissions
  try {
    const testFile = path.join(profilesDir, '.test-write');
    fs.writeFileSync(testFile, 'test');
    fs.unlinkSync(testFile);
    log('   ‚úÖ Permissions d\'√©criture OK', 'green');
  } catch (err) {
    log('   ‚ùå Pas de permissions d\'√©criture: ' + err.message, 'red');
    allGood = false;
  }

  console.log('');

  // ==========================================
  // 3. V√âRIFIER LE BACKEND
  // ==========================================
  log('üöÄ 3. V√âRIFICATION BACKEND', 'blue');
  console.log('‚îÄ'.repeat(60) + '\n');

  // Tester port 3001
  const health3001 = await testHttp('http://localhost:3001/health');
  if (health3001.ok) {
    log('   ‚úÖ Backend r√©pond sur port 3001', 'green');
  } else {
    log('   ‚ùå Backend ne r√©pond pas sur port 3001', 'red');
    allGood = false;
  }

  // Tester port 3000 (au cas o√π)
  const health3000 = await testHttp('http://localhost:3000/health');
  if (health3000.ok) {
    log('   ‚ÑπÔ∏è  Backend r√©pond aussi sur port 3000', 'cyan');
  }

  // V√©rifier que les fichiers routes existent
  const usersRoutePath = path.join(__dirname, 'server', 'routes', 'users.js');
  if (fs.existsSync(usersRoutePath)) {
    log('   ‚úÖ Fichier server/routes/users.js existe', 'green');
    
    const content = fs.readFileSync(usersRoutePath, 'utf8');
    
    // V√©rifier les routes importantes
    if (content.includes("router.get('/profile'")) {
      log('   ‚úÖ Route GET /profile existe', 'green');
    } else {
      log('   ‚ùå Route GET /profile manquante', 'red');
      allGood = false;
    }

    if (content.includes("router.post('/profile/image'")) {
      log('   ‚úÖ Route POST /profile/image existe', 'green');
    } else {
      log('   ‚ùå Route POST /profile/image manquante', 'red');
      allGood = false;
    }

    if (content.includes("router.delete('/profile/image'")) {
      log('   ‚úÖ Route DELETE /profile/image existe', 'green');
    } else {
      log('   ‚ùå Route DELETE /profile/image manquante', 'red');
      allGood = false;
    }

    if (content.includes('COALESCE')) {
      log('   ‚úÖ COALESCE utilis√© (gestion NULL)', 'green');
    } else {
      log('   ‚ö†Ô∏è  COALESCE pas trouv√© (risque erreur 500)', 'yellow');
    }

    if (content.includes('multer')) {
      log('   ‚úÖ Multer import√©', 'green');
    } else {
      log('   ‚ùå Multer non import√©', 'red');
      allGood = false;
    }
  } else {
    log('   ‚ùå Fichier server/routes/users.js manquant', 'red');
    allGood = false;
  }

  console.log('');

  // ==========================================
  // 4. V√âRIFIER LE FRONTEND
  // ==========================================
  log('üíª 4. V√âRIFICATION FRONTEND', 'blue');
  console.log('‚îÄ'.repeat(60) + '\n');

  const profilePath = path.join(__dirname, 'client', 'src', 'pages', 'Profile.js');
  if (fs.existsSync(profilePath)) {
    log('   ‚úÖ Fichier client/src/pages/Profile.js existe', 'green');
    
    const content = fs.readFileSync(profilePath, 'utf8');
    
    if (content.includes('handleImageUpload')) {
      log('   ‚úÖ Fonction handleImageUpload existe', 'green');
    } else {
      log('   ‚ùå Fonction handleImageUpload manquante', 'red');
      allGood = false;
    }

    if (content.includes('setProfile')) {
      log('   ‚úÖ Mise √† jour d\'√©tat (setProfile) pr√©sente', 'green');
    } else {
      log('   ‚ö†Ô∏è  setProfile non trouv√©', 'yellow');
    }

    if (content.includes('localhost:3001') || content.includes('REACT_APP_API_URL')) {
      log('   ‚úÖ URL backend correcte (port 3001)', 'green');
    } else if (content.includes('localhost:3000')) {
      log('   ‚ö†Ô∏è  URL utilise port 3000 (devrait √™tre 3001)', 'yellow');
    }

    if (content.includes('?t=') || content.includes('Date.now()')) {
      log('   ‚úÖ Cache busting impl√©ment√©', 'green');
    } else {
      log('   ‚ö†Ô∏è  Pas de cache busting (risque de cache)', 'yellow');
    }
  } else {
    log('   ‚ùå Fichier client/src/pages/Profile.js manquant', 'red');
    allGood = false;
  }

  // V√©rifier le ThemeContext
  const themeContextPath = path.join(__dirname, 'client', 'src', 'contexts', 'ThemeContext.js');
  if (fs.existsSync(themeContextPath)) {
    log('   ‚úÖ ThemeContext existe', 'green');
  } else {
    log('   ‚ö†Ô∏è  ThemeContext manquant', 'yellow');
  }

  console.log('');

  // ==========================================
  // 5. V√âRIFIER LES PROCESSUS
  // ==========================================
  log('‚öôÔ∏è  5. V√âRIFICATION PROCESSUS', 'blue');
  console.log('‚îÄ'.repeat(60) + '\n');

  const { exec } = require('child_process');
  
  exec('netstat -ano | findstr :3001', (err, stdout) => {
    if (stdout) {
      log('   ‚úÖ Port 3001 en √©coute (backend)', 'green');
    } else {
      log('   ‚ö†Ô∏è  Port 3001 pas en √©coute', 'yellow');
    }
  });

  exec('netstat -ano | findstr :3000', (err, stdout) => {
    if (stdout) {
      log('   ‚úÖ Port 3000 en √©coute (frontend)', 'green');
    } else {
      log('   ‚ö†Ô∏è  Port 3000 pas en √©coute', 'yellow');
    }
  });

  console.log('');

  // ==========================================
  // R√âSUM√â
  // ==========================================
  console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  if (allGood) {
    log('‚ïë              ‚úÖ TOUS LES TESTS SONT PASS√âS !            ‚ïë', 'green');
  } else {
    log('‚ïë              ‚ö†Ô∏è  QUELQUES PROBL√àMES D√âTECT√âS            ‚ïë', 'yellow');
  }
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

  // ==========================================
  // INSTRUCTIONS
  // ==========================================
  log('üìù PROCHAINES √âTAPES:', 'cyan');
  console.log('');

  if (allGood) {
    console.log('1. ‚úÖ Tous les syst√®mes sont op√©rationnels');
    console.log('2. üåê Ouvrir http://localhost:3000/profile');
    console.log('3. üì∏ Tester l\'upload de photo');
    console.log('4. ‚ú® Profiter des fonctionnalit√©s !');
  } else {
    console.log('1. üîß Corriger les probl√®mes d√©tect√©s ci-dessus');
    console.log('2. üîÑ Red√©marrer les serveurs si n√©cessaire:');
    console.log('   - Backend: cd server && npm start');
    console.log('   - Frontend: cd client && npm start');
    console.log('3. üîÅ Relancer ce script: node test-profile-complete.js');
  }

  console.log('');
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'cyan');
  console.log('');
}

verifyProfile().catch(console.error);
